<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GridScan v1.4 (ì•ˆì •ì„± ë° UX ê°œì„ )</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=Bdae71c83941e7abbe59827c2625be7b&libraries=services"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; color: #212529; }
        .main-container { background-color: #ffffff; border: 1px solid #dee2e6; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .title-text { color: #14b8a6; }
        .search-button { background-color: #14b8a6; color: #ffffff; transition: all 0.2s ease-in-out; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .search-button:hover { background-color: #0d9488; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .search-button:disabled { background-color: #94a3b8; cursor: not-allowed; transform: none; box-shadow: none; }
        /* v1.4: ì¤‘ë‹¨ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .cancel-button { background-color: #ef4444; color: #ffffff; transition: all 0.2s ease-in-out; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .cancel-button:hover { background-color: #dc2626; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .progress-bar { background-color: #e9ecef; border-radius: 9999px; overflow: hidden; }
        .progress-bar-fill { background-color: #14b8a6; transition: width 0.3s ease-in-out; }
        .result-table { width: 100%; border-collapse: collapse; }
        .result-table th, .result-table td { border: 1px solid #dee2e6; padding: 0.75rem; text-align: left; }
        .result-table thead { background-color: #f1f5f9; }
        .result-table tbody tr:nth-child(even) { background-color: #f8fafc; }
        .status-pass { color: #16a34a; font-weight: bold; }
        .status-fail { color: #ef4444; font-weight: bold; }
        .address-counter.over-limit { color: #ef4444; font-weight: bold; }
        
        /* v1.4: í† ìŠ¤íŠ¸ ì•Œë¦¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #212529;
            color: #ffffff;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
            opacity: 0;
        }
        .toast-notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        .toast-notification.error {
            background-color: #dc2626;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="main-container w-full max-w-4xl mx-auto rounded-2xl p-6 sm:p-8 space-y-8">
        
        <div class="text-center space-y-2">
            <h1 class="text-3xl sm:text-4xl font-bold title-text">âš¡ï¸ GridScan v1.4 âš¡ï¸</h1>
            <p class="text-gray-600 text-sm sm:text-base">ì—¬ëŸ¬ ì£¼ì†Œë¥¼ í•œ ë²ˆì— ë¶„ì„í•˜ê³  ê²°ê³¼ë¥¼ ë°›ì•„ë³´ì„¸ìš”.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <div class="flex justify-between items-center mb-2">
                    <label for="address-list" class="block text-lg font-semibold text-gray-700">ì£¼ì†Œ ëª©ë¡ ë¶™ì—¬ë„£ê¸°</label>
                    <span id="address-counter" class="text-sm font-medium text-gray-500">0 / 200 ê°œ</span>
                </div>
                <textarea id="address-list" rows="10" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="ì˜ˆ:&#10;ê²½ê¸°ë„ ì„±ë‚¨ì‹œ ì¤‘ì›êµ¬ ë„ì´Œë‚¨ë¡œ 101&#10;ê²½ê¸°ë„ ê³ ì–‘ì‹œ ë•ì–‘êµ¬ í–¥ë™ë™ 407&#10;(í•œ ì¤„ì— ì£¼ì†Œ í•˜ë‚˜ì”© ì…ë ¥)"></textarea>
            </div>
            <div class="flex flex-col justify-between">
                <div>
                    <p class="text-lg font-semibold text-gray-700 mb-2">ë˜ëŠ” CSV íŒŒì¼ ì—…ë¡œë“œ</p>
                    <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"/>
                    <p class="text-xs text-gray-500 mt-2">ì²« ë²ˆì§¸ ì—´ì— ì£¼ì†Œê°€ í¬í•¨ëœ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
                </div>
                <button id="start-analysis-btn" class="search-button w-full font-bold py-4 px-8 rounded-lg text-lg mt-4">ë¶„ì„ ì‹œì‘</button>
            </div>
        </div>

        <div id="progress-section" class="hidden pt-6 space-y-2">
            <div class="flex justify-between items-center font-semibold">
                <span id="progress-label" class="text-teal-600">ë¶„ì„ ì¤€ë¹„ ì¤‘...</span>
                <span id="progress-text" class="text-gray-700">0 / 0</span>
            </div>
            <div class="progress-bar h-4">
                <div id="progress-bar-fill" class="progress-bar-fill h-4" style="width: 0%;"></div>
            </div>
            <!-- v1.4: ë¶„ì„ ì¤‘ë‹¨ ë²„íŠ¼ ì¶”ê°€ -->
            <div class="text-center mt-4">
                <button id="cancel-analysis-btn" class="cancel-button font-bold py-2 px-6 rounded-lg text-base">ë¶„ì„ ì¤‘ë‹¨</button>
            </div>
        </div>

        <div id="result-section" class="hidden pt-6">
            <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-4">
                <h2 class="text-2xl font-bold text-gray-800">ì¢…í•© ë¶„ì„ ê²°ê³¼</h2>
                <button id="download-csv-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-green-700 transition-colors w-full sm:w-auto">ê²°ê³¼ ë‹¤ìš´ë¡œë“œ (CSV)</button>
            </div>
            <div class="overflow-x-auto border rounded-lg">
                <table class="result-table text-sm">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>ì£¼ì†Œ</th>
                            <th>ì§„ë‹¨ ê²°ê³¼</th>
                            <th>ìµœê·¼ì ‘ ì‹œì„¤</th>
                            <th>ê±°ë¦¬(m)</th>
                            <th>ìµœê³  ì „ì••(kV)</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body">
                    </tbody>
                </table>
            </div>
        </div>
        
    </div>
    
    <!-- v1.4: í† ìŠ¤íŠ¸ ì•Œë¦¼ì„ ìœ„í•œ HTML ìš”ì†Œ ì¶”ê°€ -->
    <div id="toast" class="toast-notification"></div>

    <script type="module">
        // --- v1.4: ìƒìˆ˜ ê´€ë¦¬ ---
        // ì„¤ì •ê°’ë“¤ì„ ë§¨ ìœ„ì— ëª¨ì•„ì„œ ê´€ë¦¬í•˜ê¸° ì‰½ê²Œ ë§Œë“­ë‹ˆë‹¤.
        const ADDRESS_LIMIT = 200;
        const OVERPASS_API_ENDPOINT = 'https://overpass-api.de/api/interpreter';
        const SEARCH_RADIUS_METERS = 1000;
        const API_REQUEST_DELAY_MS = 500; // API ê³¼ë¶€í•˜ ë°©ì§€ë¥¼ ìœ„í•œ ì§€ì—° ì‹œê°„

        // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const addressListInput = document.getElementById('address-list');
        const csvFileInput = document.getElementById('csv-file-input');
        const startAnalysisBtn = document.getElementById('start-analysis-btn');
        const progressSection = document.getElementById('progress-section');
        const progressLabel = document.getElementById('progress-label');
        const progressText = document.getElementById('progress-text');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const resultSection = document.getElementById('result-section');
        const resultTableBody = document.getElementById('result-table-body');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        const addressCounter = document.getElementById('address-counter');
        const toast = document.getElementById('toast'); // v1.4 ì¶”ê°€
        const cancelAnalysisBtn = document.getElementById('cancel-analysis-btn'); // v1.4 ì¶”ê°€

        // --- ì „ì—­ ë³€ìˆ˜ ---
        let geocoderInstance = null;
        let analysisResults = [];
        let isAnalysisCancelled = false; // v1.4: ë¶„ì„ ì¤‘ë‹¨ ìƒíƒœë¥¼ ì €ì¥í•˜ëŠ” í”Œë˜ê·¸

        // --- ì´ˆê¸°í™” ---
        kakao.maps.load(() => {
            geocoderInstance = new kakao.maps.services.Geocoder();
        });
        
        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ---
        startAnalysisBtn.addEventListener('click', handleStartAnalysis);
        csvFileInput.addEventListener('change', handleFileUpload);
        downloadCsvBtn.addEventListener('click', downloadResultsAsCsv);
        addressListInput.addEventListener('input', updateAddressCounter);
        cancelAnalysisBtn.addEventListener('click', handleCancelAnalysis); // v1.4 ì¶”ê°€

        // --- v1.4: í† ìŠ¤íŠ¸ ì•Œë¦¼ í•¨ìˆ˜ ---
        function showToast(message, type = 'info') {
            toast.textContent = message;
            toast.className = 'toast-notification'; // Reset classes
            if (type === 'error') {
                toast.classList.add('error');
            }
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000); // 3ì´ˆ í›„ì— ì‚¬ë¼ì§
        }

        function updateAddressCounter() {
            const addresses = addressListInput.value.split('\n').map(line => line.trim()).filter(line => line);
            const count = addresses.length;
            addressCounter.textContent = `${count} / ${ADDRESS_LIMIT} ê°œ`;
            addressCounter.classList.toggle('over-limit', count > ADDRESS_LIMIT);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                const addresses = lines.map(line => line.split(',')[0]); 
                addressListInput.value = addresses.join('\n');
                updateAddressCounter();
            };
            reader.readAsText(file);
        }

        // --- v1.4: ë¶„ì„ ì¤‘ë‹¨ ì²˜ë¦¬ í•¨ìˆ˜ ---
        function handleCancelAnalysis() {
            isAnalysisCancelled = true;
            console.log('ğŸš¨ ë¶„ì„ ì¤‘ë‹¨ ë²„íŠ¼ í´ë¦­! ì¤‘ë‹¨ í”Œë˜ê·¸ë¥¼ trueë¡œ ë³€ê²½í•©ë‹ˆë‹¤.');
            showToast('ë¶„ì„ì„ ì¤‘ë‹¨í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
        }

        async function handleStartAnalysis() {
            const addresses = addressListInput.value.split('\n').map(line => line.trim()).filter(line => line);
            if (addresses.length === 0) {
                showToast('ë¶„ì„í•  ì£¼ì†Œë¥¼ ì…ë ¥í•˜ê±°ë‚˜ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (addresses.length > ADDRESS_LIMIT) {
                showToast(`í•œ ë²ˆì— ìµœëŒ€ ${ADDRESS_LIMIT}ê°œê¹Œì§€ë§Œ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ ${addresses.length}ê°œ)`, 'error');
                return;
            }

            // --- ë¶„ì„ ì‹œì‘ UI ì„¤ì • ---
            startAnalysisBtn.disabled = true;
            startAnalysisBtn.textContent = 'ë¶„ì„ ì¤‘...';
            resultSection.classList.add('hidden');
            progressSection.classList.remove('hidden');
            resultTableBody.innerHTML = '';
            analysisResults = [];
            isAnalysisCancelled = false; // ë¶„ì„ ì‹œì‘ ì‹œ ì¤‘ë‹¨ í”Œë˜ê·¸ ì´ˆê¸°í™”

            for (let i = 0; i < addresses.length; i++) {
                // v1.4: ë£¨í”„ ì‹œì‘ ì „ ì¤‘ë‹¨ í”Œë˜ê·¸ í™•ì¸
                if (isAnalysisCancelled) {
                    console.log('âœ‹ ë¶„ì„ ë£¨í”„ê°€ ì¤‘ë‹¨ í”Œë˜ê·¸ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ì‘ì—…ì„ ë©ˆì¶¥ë‹ˆë‹¤.');
                    break; // ë£¨í”„ íƒˆì¶œ!
                }

                const address = addresses[i];
                progressLabel.textContent = `[${i + 1}/${addresses.length}] "${address}" ë¶„ì„ ì¤‘...`;
                progressText.textContent = `${i + 1} / ${addresses.length}`;
                progressBarFill.style.width = `${((i + 1) / addresses.length) * 100}%`;

                const result = await analyzeSingleAddress(address);
                analysisResults.push(result);
                appendResultToTable(result, i + 1);

                await new Promise(resolve => setTimeout(resolve, API_REQUEST_DELAY_MS));
            }

            // --- ë¶„ì„ ì¢…ë£Œ UI ì„¤ì • ---
            if (isAnalysisCancelled) {
                progressLabel.textContent = 'ë¶„ì„ì´ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.';
            } else {
                progressLabel.textContent = 'ë¶„ì„ ì™„ë£Œ!';
            }
            startAnalysisBtn.disabled = false;
            startAnalysisBtn.textContent = 'ë¶„ì„ ì‹œì‘';
            progressSection.classList.add('hidden');
            if (analysisResults.length > 0) {
                resultSection.classList.remove('hidden');
            }
        }

        async function analyzeSingleAddress(address) {
            try {
                const coords = await getCoordsFromAddress(address);
                const facilities = await findFacilities(coords.lat, coords.lon);
                const filtered = filterFacilities(facilities, coords.lat, coords.lon);

                if (filtered.length > 0) {
                    const closest = filtered.sort((a, b) => a.distance - b.distance)[0];
                    const highestVoltage = filtered.reduce((max, el) => parseVoltage(el.tags.voltage) > parseVoltage(max.tags.voltage) ? el : max, filtered[0]);
                    const powerTypes = { substation: 'ë³€ì „ì†Œ', line: 'ì†¡ì „ì„ ', tower: 'ì†¡ì „íƒ‘', cable: 'ì¼€ì´ë¸”' };
                    
                    return {
                        address,
                        status: 'í•´ë‹¹',
                        closestFacility: closest.tags.name || powerTypes[closest.tags.power] || 'ì‹œì„¤',
                        distance: Math.round(closest.distance),
                        highestVoltage: parseVoltage(highestVoltage.tags.voltage) / 1000
                    };
                } else {
                    return { address, status: 'í•´ë‹¹ ì—†ìŒ', closestFacility: '-', distance: '-', highestVoltage: '-' };
                }
            } catch (error) {
                return { address, status: 'ë¶„ì„ ì‹¤íŒ¨', closestFacility: error.message, distance: '-', highestVoltage: '-' };
            }
        }
        
        function getCoordsFromAddress(address) {
            return new Promise((resolve, reject) => {
                geocoderInstance.addressSearch(address, (result, status) => {
                    if (status === kakao.maps.services.Status.OK) {
                        resolve({ lat: result[0].y, lon: result[0].x });
                    } else {
                        reject(new Error('ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨'));
                    }
                });
            });
        }

        async function findFacilities(lat, lon) {
            const query = `[out:json];(node["power"](around:${SEARCH_RADIUS_METERS},${lat},${lon});way["power"](around:${SEARCH_RADIUS_METERS},${lat},${lon});relation["power"](around:${SEARCH_RADIUS_METERS},${lat},${lon}););out center;`;
            const response = await fetch(OVERPASS_API_ENDPOINT, { method: 'POST', body: query });
            if (!response.ok) throw new Error('API íƒìƒ‰ ì‹¤íŒ¨');
            const data = await response.json();
            return data.elements;
        }

        function filterFacilities(elements, centerLat, centerLon) {
            const distanceRules = {
                line: { '765000': 1000, '500000': 800, '345000': 700 },
                substation: { '765000': 850, '500000': 800, '345000': 600 }
            };

            const elementsWithDistance = elements.map(el => {
                const facilityCoords = el.center || el;
                const distance = haversineDistance(centerLat, centerLon, facilityCoords.lat, facilityCoords.lon);
                return { ...el, distance };
            });

            return elementsWithDistance.filter(el => {
                const powerTag = el.tags?.power;
                const voltage = parseVoltage(el.tags?.voltage);
                if (voltage === 0 || !powerTag) return false;
                let ruleType;
                if (['line', 'tower', 'cable'].includes(powerTag)) ruleType = 'line';
                else if (powerTag === 'substation') ruleType = 'substation';
                else return false;
                const ruleVoltage = String(voltage);
                if (!distanceRules[ruleType][ruleVoltage]) return false;
                const maxDistance = distanceRules[ruleType][ruleVoltage];
                return el.distance <= maxDistance;
            });
        }

        function appendResultToTable(result, index) {
            const row = document.createElement('tr');
            const statusClass = result.status === 'í•´ë‹¹' ? 'status-fail' : (result.status === 'í•´ë‹¹ ì—†ìŒ' ? 'status-pass' : '');
            row.innerHTML = `
                <td class="text-center">${index}</td>
                <td>${result.address}</td>
                <td class="${statusClass}">${result.status}</td>
                <td>${result.closestFacility}</td>
                <td class="text-right">${result.distance}</td>
                <td class="text-right">${result.highestVoltage}</td>
            `;
            resultTableBody.appendChild(row);
        }
        
        function downloadResultsAsCsv() {
            if (analysisResults.length === 0) {
                showToast('ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM for Excel
            csvContent += "No.,ì£¼ì†Œ,ì§„ë‹¨ ê²°ê³¼,ìµœê·¼ì ‘ ì‹œì„¤,ê±°ë¦¬(m),ìµœê³  ì „ì••(kV)\n";

            analysisResults.forEach((result, index) => {
                const row = [
                    index + 1,
                    `"${result.address.replace(/"/g, '""')}"`,
                    result.status,
                    `"${result.closestFacility.toString().replace(/"/g, '""')}"`,
                    result.distance,
                    result.highestVoltage
                ].join(',');
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `GridScan_results_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function parseVoltage(voltageTag) {
            if (!voltageTag) return 0;
            if (typeof voltageTag === 'string') {
                const voltages = voltageTag.split(';').map(v => parseInt(v.replace(/\D/g, ''))).filter(v => !isNaN(v));
                return voltages.length > 0 ? Math.max(...voltages) : 0;
            }
            if (typeof voltageTag === 'number') return voltageTag;
            return 0;
        }
    </script>
</body>
</html>