<!DOCTYPE html>
<html lang="ko">
<head>
    <style>
        /* ... styles ... */
    </style>
</head>
<body>
    <script type="module">
      // --- Firebase SDK Import ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
      import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, onSnapshot, query, orderBy, writeBatch, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

      // --- 전역 변수 및 DOM 요소 (v1.3과 동일) ---
      let auth, db;
      let currentPageId = null, editorComponents = [], editorPageSettings = {}, activeEditorComponentId = null, draggedEditorComponentId = null; 
      const authContainer = document.getElementById('auth-container');
      const appContainer = document.getElementById('app-container');
      const dashboardView = document.getElementById('view-dashboard');
      const editorView = document.getElementById('view-editor');
      const loginButton = document.getElementById('login-button');
      const passwordInput = document.getElementById('password-input');
      const authMessage = document.getElementById('auth-message');

      // --- 1. 앱 초기화 및 인증 상태 확인 (v1.3과 동일) ---
      document.addEventListener('DOMContentLoaded', initializeAppCore);
      async function initializeAppCore() {
          try {
              const response = await fetch('/.netlify/functions/get-firebase-config');
              if (!response.ok) throw new Error(`Netlify Function 응답 실패`);
              const firebaseConfig = await response.json();
              const app = initializeApp(firebaseConfig);
              auth = getAuth(app);
              db = getFirestore(app);
              onAuthStateChanged(auth, (user) => {
                  if (user) {
                      authContainer.style.display = 'none';
                      appContainer.style.display = 'block';
                      handleRouting();
                  } else {
                      authContainer.style.display = 'block';
                      appContainer.style.display = 'none';
                  }
              });
              loginButton.addEventListener('click', handleLogin);
              passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
              window.addEventListener('hashchange', handleRouting);
          } catch (error) { showAuthMessage("초기화에 실패했습니다.", true); }
      }

      // --- 2. 로그인 로직 (v1.4 디버깅 강화) ---
      async function handleLogin() {
          setButtonLoading(loginButton, true, "로그인 시도...");
          console.log("--- 로그인 프로세스 시작 ---");
          const password = passwordInput.value;

          try {
              // 1단계: Netlify Function 호출하여 토큰 요청
              console.log("1/3: Netlify Function '/.netlify/functions/login' 호출 시도...");
              const response = await fetch('/.netlify/functions/login', { 
                  method: 'POST', 
                  headers: { 'Content-Type': 'application/json' }, 
                  body: JSON.stringify({ password: password }) 
              });
              
              console.log("2/3: Netlify Function 응답 받음. 상태:", response.status);
              const result = await response.json();

              if (response.ok && result.success) {
                  console.log("✅ Netlify Function 인증 성공. Firebase 토큰 수신 완료.");
                  
                  // 2단계: Firebase에 커스텀 토큰으로 로그인 시도
                  console.log("3/3: Firebase 'signInWithCustomToken' 실행 시도...");
                  await signInWithCustomToken(auth, result.token);
                  console.log("✅ Firebase 로그인 최종 성공!");
                  // 성공 시 onAuthStateChanged 리스너가 화면 전환을 처리함
              } else {
                  console.warn("❌ Netlify Function 인증 실패:", result.message || "서버 응답 오류");
                  showAuthMessage(result.message || "로그인 실패.", true);
                  setButtonLoading(loginButton, false, "로그인");
              }
          } catch (error) {
              console.error("❌ 로그인 프로세스 중 심각한 오류 발생:", error);
              showAuthMessage("로그인 중 알 수 없는 오류 발생.", true);
              setButtonLoading(loginButton, false, "로그인");
          }
      }

      // --- 3. SPA 라우팅 로직 (v1.3과 동일) ---
      function handleRouting() { /* ... */ }
      function navigateTo(path) { /* ... */ }
      function showView(viewName) { /* ... */ }
      
      // --- 4. 대시보드 뷰 로직 (v1.3과 동일) ---
      function loadDashboardContent() { /* ... */ }
      function createPageListItemHTML(page) { /* ... */ }
      function bindDashboardEvents(container, pageDataArray) { /* ... */ }
      async function handleAddNewPage() { /* ... */ }
      async function handleDeletePage(pageId, pageDataArray) { /* ... */ }
      async function handleTogglePageStatus(pageId, isActive) { /* ... */ }

      // --- 5. 편집기 뷰 로직 (v1.3에서 이식됨) ---
      const allPossibleFormFields = [ /* ... */ ];
      const viewportOptions = [ /* ... */ ];
      async function loadEditorContent(pageId) { /* ... */ }
      function getEditorBaseHTML() { /* ... */ }
      function renderEditorAll() { /* ... */ }
      function renderEditorPreview() { /* ... */ }
      function renderEditorControls() { /* ... */ }
      function renderEditorViewportControls() { /* ... */ }
      function bindEditorGlobalEvents() { /* ... */ }
      function bindEditorPanelEvents() { /* ... */ }
      function addEditorComponent(type) { /* ... */ }
      function deleteEditorComponent(id) { /* ... */ }
      function selectEditorComponent(id) { /* ... */ }
      function updateEditorComponentProperty(id, keyPath, value) { /* ... */ }
      function updateEditorComponentStyle(id, key, value) { /* ... */ }
      function handleEditorFieldToggle(id, fieldName, isChecked) { /* ... */ }
      function handleEditorDragStart(e) { /* ... */ }
      function handleEditorDragOver(e) { /* ... */ }
      function handleEditorDragLeave(e) { /* ... */ }
      function handleEditorDrop(e) { /* ... */ }
      function handleEditorDragEnd(e) { /* ... */ }
      async function saveEditorDataToFirestore() { /* ... */ }
      
      // --- 유틸리티 함수 (v1.3과 동일) ---
      function showAuthMessage(message, isError) { /* ... */ }
      function setButtonLoading(buttonElement, isLoading, text) { /* ... */ }
      function hexToRgba(hex, alpha = 1) { /* ... */ }
      
      // *** HELPER FUNCTIONS (v1.3 -> v1.4 migration) ***
      // To ensure all functions are defined, copy implementations from previous version if a function above is commented out as /* ... */
      // Example: function handleRouting() { const hash = window.location.hash; ... }

    </script>
</body>
</html>