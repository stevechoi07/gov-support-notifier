<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© ê´€ë¦¬ì v1.1 (SPA)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; }
        .view-container { display: none; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ (ë²„íŠ¼ìš©) */
        .spinner { border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 16px; height: 16px; animation: spin 1s ease-in-out infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        button:disabled { background-color: #94a3b8; cursor: not-allowed; }
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-sm p-8 bg-white rounded-xl shadow-lg">
                <h1 class="text-2xl font-bold text-center text-slate-800 mb-6">ğŸ”’ ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
                <input type="password" id="password-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 text-lg">
                <button id="login-button" class="w-full mt-4 px-4 py-3 bg-sky-500 text-white rounded-lg font-semibold hover:bg-sky-600 shadow-md transition-colors text-lg">ë¡œê·¸ì¸</button>
                <p id="auth-message" class="text-sm text-center mt-4 hidden"></p>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="view-dashboard" class="view-container w-full max-w-4xl mx-auto p-4 sm:p-6">
            </div>

        <div id="view-editor" class="view-container">
            </div>
    </div>

    <script type="module">
      // --- Firebase SDK Import ---
      // v1.1: import êµ¬ë¬¸ì„ í•œ ê³³ìœ¼ë¡œ ëª¨ì•„ì„œ ì¤‘ë³µ ê°€ëŠ¥ì„±ì„ ì›ì²œ ì°¨ë‹¨í•©ë‹ˆë‹¤.
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
      import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, onSnapshot, query, orderBy, writeBatch, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

      // --- ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ ---
      let auth, db;
      let currentPageId = null; // í¸ì§‘ê¸°ê°€ ì‚¬ìš©í•  í˜ì´ì§€ ID

      // --- DOM ìš”ì†Œ ìºì‹± ---
      const authContainer = document.getElementById('auth-container');
      const appContainer = document.getElementById('app-container');
      const dashboardView = document.getElementById('view-dashboard');
      const editorView = document.getElementById('view-editor');
      const loginButton = document.getElementById('login-button');
      const passwordInput = document.getElementById('password-input');
      const authMessage = document.getElementById('auth-message');

      // --- 1. ì•± ì´ˆê¸°í™” ë° ì¸ì¦ ìƒíƒœ í™•ì¸ ---
      document.addEventListener('DOMContentLoaded', initializeAppCore);

      async function initializeAppCore() {
          console.log("DOM ë¡œë“œ ì™„ë£Œ. Firebase ì´ˆê¸°í™” ì‹œì‘...");
          try {
              const response = await fetch('/.netlify/functions/get-firebase-config');
              if (!response.ok) throw new Error(`Netlify Function ì‘ë‹µ ì‹¤íŒ¨ (ìƒíƒœ: ${response.status})`);
              const firebaseConfig = await response.json();

              const app = initializeApp(firebaseConfig);
              auth = getAuth(app);
              db = getFirestore(app);
              console.log("Firebase ì´ˆê¸°í™” ì„±ê³µ.");

              // ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ: ë¡œê·¸ì¸ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°ì§€
              onAuthStateChanged(auth, (user) => {
                  if (user) {
                      console.log("ì¸ì¦ ìƒíƒœ: ë¡œê·¸ì¸ë¨ (User ID:", user.uid, ")");
                      authContainer.style.display = 'none';
                      appContainer.style.display = 'block';
                      // URL í•´ì‹œê°’ì„ ê¸°ë°˜ìœ¼ë¡œ ë¼ìš°íŒ… (ìƒˆë¡œê³ ì¹¨ ì‹œ í˜„ì¬ ë·° ìœ ì§€)
                      handleRouting();
                  } else {
                      console.log("ì¸ì¦ ìƒíƒœ: ë¡œê·¸ì•„ì›ƒë¨");
                      authContainer.style.display = 'block';
                      appContainer.style.display = 'none';
                  }
              });

              loginButton.addEventListener('click', handleLogin);
              passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
              // URL í•´ì‹œ ë³€ê²½ ê°ì§€ (ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ë²„íŠ¼)
              window.addEventListener('hashchange', handleRouting);

          } catch (error) {
              console.error("ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
              showAuthMessage("ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Netlify Function ë°°í¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.", true);
          }
      }

      // --- 2. ë¡œê·¸ì¸ ë¡œì§ ---
      async function handleLogin() {
          const password = passwordInput.value;
          if (!password) { showAuthMessage("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", true); return; }
          setButtonLoading(loginButton, true, "ë¡œê·¸ì¸ ì¤‘...");

          try {
              const response = await fetch('/.netlify/functions/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password }) });
              const result = await response.json();
              if (response.ok && result.success) {
                  await signInWithCustomToken(auth, result.token);
                  // ì„±ê³µ ì‹œ onAuthStateChanged ë¦¬ìŠ¤ë„ˆê°€ í™”ë©´ ì „í™˜ì„ ì²˜ë¦¬í•¨
                  console.log("ë¡œê·¸ì¸ ì„±ê³µ, í† í° ì¸ì¦ ì™„ë£Œ.");
              } else {
                  showAuthMessage(result.message || "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.", true);
                  setButtonLoading(loginButton, false, "ë¡œê·¸ì¸");
              }
          } catch (error) {
              console.error('ë¡œê·¸ì¸ ìš”ì²­ ì˜¤ë¥˜:', error);
              showAuthMessage("ë¡œê·¸ì¸ ì„œë²„ í†µì‹  ì˜¤ë¥˜.", true);
              setButtonLoading(loginButton, false, "ë¡œê·¸ì¸");
          }
      }

      // --- 3. SPA ë¼ìš°íŒ… ë¡œì§ ---
      function handleRouting() {
          const hash = window.location.hash;
          console.log("ë¼ìš°íŒ… ì‹¤í–‰. í•´ì‹œ:", hash);

          if (hash.startsWith('#editor/')) {
              currentPageId = hash.split('/')[1];
              showView('editor');
              loadEditorContent(currentPageId);
          } else {
              showView('dashboard');
              loadDashboardContent();
          }
      }
      
      function navigateTo(path) {
          window.location.hash = path;
      }

      function showView(viewName) {
          dashboardView.style.display = (viewName === 'dashboard') ? 'block' : 'none';
          editorView.style.display = (viewName === 'editor') ? 'block' : 'none';
      }

      // --- 4. ëŒ€ì‹œë³´ë“œ ë·° (í˜ì´ì§€ ëª©ë¡) ---
      function loadDashboardContent() {
          console.log("ëŒ€ì‹œë³´ë“œ ì½˜í…ì¸  ë¡œë”© ì¤‘...");
          // UI í…œí”Œë¦¿ ë Œë”ë§
          dashboardView.innerHTML = `
              <div class="flex justify-between items-center mb-6">
                  <h1 class="text-2xl font-bold text-slate-800">ğŸ“‹ ë‚˜ì˜ í˜ì´ì§€ ëª©ë¡</h1>
                  <button id="add-new-page-btn" class="px-6 py-2 bg-sky-500 text-white rounded-lg font-semibold hover:bg-sky-600 shadow-md transition-colors">â• ìƒˆ í˜ì´ì§€ ë§Œë“¤ê¸°</button>
              </div>
              <div id="page-list-container" class="space-y-4"></div>
          `;
          
          // ìƒˆ í˜ì´ì§€ ë§Œë“¤ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
          document.getElementById('add-new-page-btn').onclick = handleAddNewPage;

          // Firestoreì—ì„œ ë°ì´í„° ì‹¤ì‹œê°„ êµ¬ë…
          const pagesRef = collection(db, "pages");
          const q = query(pagesRef, orderBy("order", "asc"));
          onSnapshot(q, (querySnapshot) => {
              const pageListContainer = document.getElementById('page-list-container');
              if (!pageListContainer) return; // ë·°ê°€ ì „í™˜ëœ ê²½ìš° ë°©ì§€

              pageListContainer.innerHTML = '';
              let pageDataArray = []; // SortableJS ìˆœì„œ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ë°°ì—´ì— ì €ì¥

              if (querySnapshot.empty) {
                  pageListContainer.innerHTML = `<p class="text-center text-slate-500 py-8">ìƒì„±ëœ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                  return;
              }

              querySnapshot.forEach((doc) => {
                  pageDataArray.push({ id: doc.id, ...doc.data() });
                  const page = pageDataArray[pageDataArray.length - 1];
                  const pageElement = createPageListItemHTML(page);
                  pageListContainer.insertAdjacentHTML('beforeend', pageElement);
              });
              
              // ëª©ë¡ ë Œë”ë§ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë°”ì¸ë”©
              bindDashboardEvents(pageListContainer, pageDataArray);
          });
      }

      function createPageListItemHTML(page) {
          const pageTitle = page.title || "ì œëª© ì—†ìŒ";
          const lastUpdated = page.updatedAt ? new Date(page.updatedAt.seconds * 1000).toLocaleString('ko-KR') : "ì •ë³´ ì—†ìŒ";
          const isChecked = page.isActive !== false ? 'checked' : '';
          const inactiveClass = page.isActive === false ? 'opacity-40' : '';

          return `
            <div class="page-item bg-white rounded-xl shadow-md ${inactiveClass}" data-id="${page.id}">
                <div class="p-4 flex items-center gap-4">
                    <div class="drag-handle text-slate-400 p-2 cursor-grab hidden sm:block"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg></div>
                    <div class="w-12 h-12 flex-shrink-0 bg-sky-100 text-sky-500 rounded-lg flex items-center justify-center text-2xl">ğŸ“„</div>
                    <div class="flex-grow overflow-hidden">
                        <p class="font-bold text-slate-800 truncate">${pageTitle}</p>
                        <p class="text-sm text-slate-500 mt-1">ìµœì¢… ìˆ˜ì •: ${lastUpdated}</p>
                    </div>
                    <div class="flex-shrink-0">
                        <label class="toggle-switch relative inline-block w-[50px] h-[30px]">
                            <input type="checkbox" class="page-status-toggle opacity-0 w-0 h-0" ${isChecked}>
                            <span class="slider absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-gray-300 transition duration-400 rounded-full before:absolute before:content-[''] before:h-[22px] before:w-[22px] before:left-[4px] before:bottom-[4px] before:bg-white before:transition before:duration-400 before:rounded-full"></span>
                        </label>
                    </div>
                </div>
                <div class="border-t p-2 flex justify-end gap-2">
                    <button class="edit-page-button text-sm font-medium text-sky-600 hover:bg-sky-50 px-4 py-2 rounded-md">ìˆ˜ì •í•˜ê¸°</button>                    
                    <button class="delete-page-button text-sm font-medium text-red-600 hover:bg-red-50 px-4 py-2 rounded-md">ì‚­ì œ</button>
                </div>
            </div>
          `;
      }
      
      function bindDashboardEvents(container, pageDataArray) {
          container.querySelectorAll('.edit-page-button').forEach(btn => {
              btn.onclick = () => navigateTo(`editor/${btn.closest('.page-item').dataset.id}`);
          });
          container.querySelectorAll('.delete-page-button').forEach(btn => {
              btn.onclick = () => handleDeletePage(btn.closest('.page-item').dataset.id, pageDataArray);
          });
          container.querySelectorAll('.page-status-toggle').forEach(toggle => {
              toggle.onchange = (e) => handleTogglePageStatus(e.target.closest('.page-item').dataset.id, e.target.checked);
          });
          
          // SortableJS ì´ˆê¸°í™”
          new Sortable(container, {
              handle: '.drag-handle', animation: 150,
              onEnd: async (evt) => updatePageOrder(evt, pageDataArray)
          });
          // CSS íŠ¸ë¦­: input:checked + span.slider:before { transform: translateX(20px); } input:checked + span.slider { background-color: #2563eb; }
          // Tailwind CSSì—ì„œëŠ” peer-checked/peer-focus ë“±ì„ ì‚¬ìš©í•˜ë‚˜, ì—¬ê¸°ì„œëŠ” ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ì´ë‚˜ ë³„ë„ CSS í´ë˜ìŠ¤ë¡œ ì²˜ë¦¬í•´ì•¼ í•¨.
          // ì„ì‹œë¡œ CSS í´ë˜ìŠ¤ í† ê¸€ ë°©ì‹ ëŒ€ì‹ , style íƒœê·¸ì— ì§ì ‘ ì •ì˜í•˜ê±°ë‚˜ (ìœ„ì˜ ì˜ˆì‹œì²˜ëŸ¼) ê°„ë‹¨í•œ JS í† ê¸€ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          // ì—¬ê¸°ì„œëŠ” createPageListItemHTMLì—ì„œ inactiveClassë¡œ ìƒìœ„ divì˜ íˆ¬ëª…ë„ë¥¼ ì¡°ì ˆí•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©.
      }

      async function handleAddNewPage() {
          console.log("ìƒˆ í˜ì´ì§€ ìƒì„± ì‹œë„...");
          const newPageData = {
              title: "ìƒˆ í˜ì´ì§€ ì œëª©",
              isActive: false,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp(),
              order: document.querySelectorAll('#page-list-container .page-item').length,
              components: [], // ë¹ˆ ë¸”ë¡ ë°°ì—´
              pageSettings: { bgColor: '#DCEAF7', bgImage: '', bgVideo: '' } // ê¸°ë³¸ ì„¤ì •
          };

          try {
              const docRef = await addDoc(collection(db, "pages"), newPageData);
              console.log("ìƒˆ í˜ì´ì§€ ìƒì„± ì™„ë£Œ, ID:", docRef.id);
              navigateTo(`editor/${docRef.id}`);
          } catch (error) {
              console.error("ìƒˆ í˜ì´ì§€ ìƒì„± ì˜¤ë¥˜:", error);
              alert("í˜ì´ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
      }

      async function handleDeletePage(pageId, pageDataArray) {
          const pageTitle = pageDataArray.find(p => p.id === pageId)?.title || "í•´ë‹¹ í˜ì´ì§€";
          if (confirm(`'${pageTitle}' í˜ì´ì§€ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
              try {
                  await deleteDoc(doc(db, "pages", pageId));
              } catch (error) { console.error("í˜ì´ì§€ ì‚­ì œ ì˜¤ë¥˜:", error); }
          }
      }

      async function handleTogglePageStatus(pageId, isActive) {
          try {
              await updateDoc(doc(db, "pages", pageId), { isActive: isActive, updatedAt: serverTimestamp() });
          } catch (error) { console.error("ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error); }
      }

      async function updatePageOrder(evt, pageDataArray) {
          const movedItem = pageDataArray.splice(evt.oldIndex, 1)[0];
          pageDataArray.splice(evt.newIndex, 0, movedItem);
          const batch = writeBatch(db);
          pageDataArray.forEach((page, index) => {
              batch.update(doc(db, "pages", page.id), { order: index });
          });
          try { await batch.commit(); } catch (error) { console.error("ìˆœì„œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error); }
      }

      // --- 5. í¸ì§‘ê¸° ë·° (ì½˜í…ì¸  ìˆ˜ì •) ---
      function loadEditorContent(pageId) {
          console.log(`í¸ì§‘ê¸° ì½˜í…ì¸  ë¡œë”© ì¤‘ (ID: ${pageId})...`);
          // TODO: ì—¬ê¸°ì— ê¸°ì¡´ creatlp.htmlì˜ í¸ì§‘ê¸° UIì™€ ë¡œì§ì„ ì´ì‹í•©ë‹ˆë‹¤.
          // 1. createlp.htmlì˜ body ë‚´ìš©ì„ ê°€ì ¸ì™€ì„œ editorView.innerHTMLì— ì‚½ì…í•©ë‹ˆë‹¤.
          // 2. creatlp.htmlì˜ ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ì„ ê°€ì ¸ì™€ì„œ ì—¬ê¸°ì„œ ì‹¤í–‰ë˜ë„ë¡ ìˆ˜ì •í•©ë‹ˆë‹¤.
          // 3. (ì¤‘ìš”) í¸ì§‘ê¸°ì˜ load/save í•¨ìˆ˜ê°€ pageIdë¥¼ ì‚¬ìš©í•˜ì—¬ Firestoreì™€ í†µì‹ í•˜ë„ë¡ ë³€ê²½í•©ë‹ˆë‹¤.
          editorView.innerHTML = `
              <div class="p-8">
                  <h2 class="text-2xl font-bold mb-4">í˜ì´ì§€ í¸ì§‘ê¸° (ID: ${pageId})</h2>
                  <p class="mb-4">ì—¬ê¸°ì— creatlp.htmlì˜ í¸ì§‘ê¸° UIê°€ ë“¤ì–´ì˜¬ ì˜ˆì •ì…ë‹ˆë‹¤.</p>
                  <button onclick="navigateTo('')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</button>
              </div>
          `;
          // ì„ì‹œë¡œ ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ (ì¸ë¼ì¸ í´ë¦­ ì´ë²¤íŠ¸ìš©)
          window.navigateTo = navigateTo;
      }

      // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
      function showAuthMessage(message, isError) {
          authMessage.textContent = message;
          authMessage.className = `text-sm text-center mt-4 ${isError ? 'text-red-500' : 'text-slate-500'}`;
          authMessage.classList.remove('hidden');
      }

      function setButtonLoading(buttonElement, isLoading, loadingText) {
          buttonElement.disabled = isLoading;
          if (isLoading) {
              buttonElement.innerHTML = `<span class="spinner"></span>${loadingText}`;
          } else {
              buttonElement.innerHTML = loadingText;
          }
      }

    </script>
</body>
</html>