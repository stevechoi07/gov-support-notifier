<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í˜ì´ì§€ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ v1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .drag-handle { cursor: grab; }
        .sortable-ghost { background: #e0f2fe; opacity: 0.5; }
        .page-item.inactive { opacity: 0.4; }
        .button-disabled { background-color: #94a3b8; cursor: not-allowed; }
        .spinner { border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 16px; height: 16px; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* í† ê¸€ ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼ */
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 30px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 30px; }
        .toggle-slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #2563eb; }
        input:checked + .toggle-slider:before { transform: translateX(20px); }
    </style>
</head>
<body class="bg-slate-100">

    <div id="auth-container" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-sm p-8 bg-white rounded-xl shadow-lg">
            <h1 class="text-2xl font-bold text-center text-slate-800 mb-6">ğŸ”’ í˜ì´ì§€ ë¹Œë” ë¡œê·¸ì¸</h1>
            <input type="password" id="password-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 text-lg">
            <button id="login-button" class="w-full mt-4 px-4 py-3 bg-sky-500 text-white rounded-lg font-semibold hover:bg-sky-600 shadow-md transition-colors text-lg">ë¡œê·¸ì¸</button>
            <p id="auth-message" class="text-sm text-center mt-4 hidden">Firebase ì ‘ì† ì •ë³´ë¥¼ ë°›ì•„ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <div id="main-panel" class="hidden w-full max-w-4xl mx-auto p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
            <h1 class="text-2xl font-bold text-slate-800">ğŸ“‹ ë‚˜ì˜ í˜ì´ì§€ ëª©ë¡</h1>
            <button id="add-new-page-button" class="px-6 py-2 bg-sky-500 text-white rounded-lg font-semibold hover:bg-sky-600 shadow-md transition-colors">â• ìƒˆ í˜ì´ì§€ ë§Œë“¤ê¸°</button>
        </div>
        
        <div id="page-list-container" class="space-y-4">
            </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import { getAuth, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
      import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, writeBatch, query, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

      // ===============================================================
      // ğŸš€ í˜ì´ì§€ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ v1.0
      // ===============================================================
      // [ë³€ê²½ì ]
      // 1. 'ê´‘ê³  ê´€ë¦¬'ì—ì„œ 'í˜ì´ì§€ ê´€ë¦¬'ë¡œ ì»¨ì…‰ ë³€ê²½.
      // 2. Firestore ì»¬ë ‰ì…˜ ì´ë¦„ì„ 'ads'ì—ì„œ 'pages'ë¡œ ë³€ê²½.
      // 3. 'ìƒˆ í˜ì´ì§€ ë§Œë“¤ê¸°' ë²„íŠ¼ ê¸°ëŠ¥ ë° í¸ì§‘ ë¡œì§ì€ í–¥í›„ creatlp.htmlê³¼ ì—°ë™ ì˜ˆì •.
      // ===============================================================

      // --- ì „ì—­ ë³€ìˆ˜ ---
      let auth, db, pagesCollection;
      let pageList = []; // ê´‘ê³  ëª©ë¡(adList) ëŒ€ì‹  í˜ì´ì§€ ëª©ë¡(pageList) ì‚¬ìš©

      // --- DOM ìš”ì†Œ ---
      const authContainer = document.getElementById('auth-container');
      const mainPanel = document.getElementById('main-panel');
      const passwordInput = document.getElementById('password-input');
      const loginButton = document.getElementById('login-button');
      const authMessage = document.getElementById('auth-message');
      const pageListContainer = document.getElementById('page-list-container');
      const addNewPageButton = document.getElementById('add-new-page-button');

      // --- ì•± ì‹œì‘ ë° ì´ˆê¸°í™” ---
      async function startApp() {
        try {
            showAuthMessage("ë³´ì•ˆ ì„œë²„ì— ì ‘ì† ì¤‘...", false);
            const response = await fetch('/.netlify/functions/get-firebase-config');
            if (!response.ok) throw new Error(`Netlify Function ì‘ë‹µ ì‹¤íŒ¨ (ìƒíƒœ: ${response.status})`);
            const firebaseConfig = await response.json();

            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            pagesCollection = collection(db, "pages"); // ì»¬ë ‰ì…˜ ì´ë¦„ ë³€ê²½!

            setupEventListeners();
            showAuthMessage("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", false);
            loginButton.disabled = false;
        } catch (error) {
            console.error("ì•± ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
            showAuthMessage("ì´ˆê¸°í™” ì‹¤íŒ¨. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.", true);
        }
      }
      document.addEventListener('DOMContentLoaded', startApp);

      // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
      function setupEventListeners() {
        loginButton.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
        addNewPageButton.addEventListener('click', handleAddNewPage);
      }

      // --- ì¸ì¦ ë¡œì§ ---
      async function handleLogin() {
          const password = passwordInput.value;
          if (!password) { showAuthMessage("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", true); return; }
          setButtonLoading(loginButton, true, "ë¡œê·¸ì¸ ì¤‘...");

          try {
              const response = await fetch('/.netlify/functions/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: password }) });
              const result = await response.json();
              if (response.ok && result.success) {
                  await signInWithCustomToken(auth, result.token);
                  authContainer.classList.add('hidden');
                  mainPanel.classList.remove('hidden');
                  listenToPages(); // í˜ì´ì§€ ë¦¬ìŠ¤ë„ˆ í˜¸ì¶œ
                  initSortable();
              } else {
                  showAuthMessage(result.message || "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.", true);
              }
          } catch (error) {
              console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
              showAuthMessage("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.", true);
          } finally {
              setButtonLoading(loginButton, false, "ë¡œê·¸ì¸");
          }
      }

      // --- ë°ì´í„° ë¦¬ìŠ¤ë„ˆ (Firestore ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸) ---
      function listenToPages() {
        const q = query(pagesCollection, orderBy("order", "asc"));
        onSnapshot(q, (querySnapshot) => {
            pageList = [];
            querySnapshot.forEach((doc) => {
                pageList.push({ id: doc.id, ...doc.data() });
            });
            renderPageList();
        });
      }

      // --- í˜ì´ì§€ ëª©ë¡ ë Œë”ë§ ---
      function renderPageList() {
          pageListContainer.innerHTML = '';
          if (pageList.length === 0) {
              pageListContainer.innerHTML = `<p class="text-center text-slate-500 py-8">ìƒì„±ëœ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. 'ìƒˆ í˜ì´ì§€ ë§Œë“¤ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</p>`;
              return;
          }
          
          pageList.forEach((page) => {
              const pageElement = document.createElement('div');
              pageElement.className = `page-item bg-white rounded-xl shadow-md ${page.isActive === false ? 'inactive' : ''}`;
              pageElement.dataset.id = page.id;
              
              const pageTitle = page.title || "ì œëª© ì—†ìŒ";
              const pageUrl = page.urlSlug ? `/${page.urlSlug}` : "ë¯¸ì„¤ì •"; // í˜ì´ì§€ ê³ ìœ  URL (ì¶”í›„ êµ¬í˜„)
              const lastUpdated = page.updatedAt ? new Date(page.updatedAt.seconds * 1000).toLocaleString('ko-KR') : "ì •ë³´ ì—†ìŒ";
              const isChecked = page.isActive !== false ? 'checked' : '';

              pageElement.innerHTML = `
                <div class="p-4 flex items-center gap-4">
                    <div class="drag-handle text-slate-400 p-2 hidden sm:block"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg></div>
                    <div class="w-12 h-12 flex-shrink-0 bg-sky-100 text-sky-500 rounded-lg flex items-center justify-center text-2xl">ğŸ“„</div>
                    <div class="flex-grow overflow-hidden">
                        <p class="font-bold text-slate-800 truncate">${pageTitle}</p>
                        <p class="text-sm text-slate-500 mt-1">URL: ${pageUrl} | ìµœì¢… ìˆ˜ì •: ${lastUpdated}</p>
                    </div>
                    <div class="flex-shrink-0">
                        <label class="toggle-switch">
                            <input type="checkbox" class="page-status-toggle" data-id="${page.id}" ${isChecked}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="border-t p-2 flex justify-end gap-2">
                    <button class="edit-page-button text-sm font-medium text-sky-600 hover:bg-sky-50 px-4 py-2 rounded-md" data-id="${page.id}">ìˆ˜ì •í•˜ê¸°</button>                    
                    <button class="delete-page-button text-sm font-medium text-red-600 hover:bg-red-50 px-4 py-2 rounded-md" data-id="${page.id}">ì‚­ì œ</button>
                </div>
              `;
              pageListContainer.appendChild(pageElement);
          });

          // ë Œë”ë§ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
          document.querySelectorAll('.edit-page-button').forEach(btn => btn.addEventListener('click', handleEditPage));
          document.querySelectorAll('.delete-page-button').forEach(btn => btn.addEventListener('click', handleDeletePage));
          document.querySelectorAll('.page-status-toggle').forEach(toggle => toggle.addEventListener('change', handleTogglePageStatus));
      }

      // --- CRUD ë° ìƒí˜¸ì‘ìš© í•¨ìˆ˜ ---
      async function handleAddNewPage() {
          // 1ë‹¨ê³„: ë¨¼ì € Firestoreì— ê¸°ë³¸ í˜ì´ì§€ ë¬¸ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
          const newPageData = {
              title: "ìƒˆ í˜ì´ì§€ ì œëª©",
              urlSlug: `page-${Date.now()}`, // ì„ì‹œ ê³ ìœ  URL
              isActive: false,
              createdAt: new Date(),
              updatedAt: new Date(),
              order: pageList.length,
              // contentBlocks: [] // creatlp.htmlì—ì„œ ê´€ë¦¬í•  ë°ì´í„° ì˜ì—­ (ì´ˆê¸°í™”)
          };

          try {
              const docRef = await addDoc(pagesCollection, newPageData);
              console.log("ìƒˆ í˜ì´ì§€ ìƒì„± ì™„ë£Œ, ID:", docRef.id);
              // 2ë‹¨ê³„: ìƒì„±ëœ í˜ì´ì§€ IDë¥¼ ê°€ì§€ê³  í¸ì§‘ í˜ì´ì§€(createlp.html)ë¡œ ì´ë™í•©ë‹ˆë‹¤.
              window.location.href = `createlp.html?pageId=${docRef.id}`;
          } catch (error) {
              console.error("ìƒˆ í˜ì´ì§€ ìƒì„± ì˜¤ë¥˜:", error);
              alert("í˜ì´ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
      }

      function handleEditPage(event) {
          const pageId = event.target.dataset.id;
          // í˜ì´ì§€ IDë¥¼ ê°€ì§€ê³  creatlp.html í¸ì§‘ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.
          window.location.href = `createlp.html?pageId=${pageId}`;
      }

      async function handleDeletePage(event) {
          const pageId = event.target.dataset.id;
          const page = pageList.find(p => p.id === pageId);
          if (confirm(`'${page.title}' í˜ì´ì§€ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
              try {
                  await deleteDoc(doc(db, "pages", pageId));
                  // TODO: í˜ì´ì§€ì— ì—°ê²°ëœ ì´ë¯¸ì§€/íŒŒì¼ì´ ìˆë‹¤ë©´ Storageì—ì„œë„ ì‚­ì œí•˜ëŠ” ë¡œì§ ì¶”ê°€ í•„ìš”.
              } catch (error) {
                  console.error("í˜ì´ì§€ ì‚­ì œ ì˜¤ë¥˜:", error);
                  alert("í˜ì´ì§€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
          }
      }
      
      async function handleTogglePageStatus(event) {
          const pageId = event.target.dataset.id;
          const isActive = event.target.checked;
          try {
              const pageRef = doc(db, "pages", pageId);
              await updateDoc(pageRef, { isActive: isActive, updatedAt: new Date() });
              const pageElement = event.target.closest('.page-item');
              pageElement.classList.toggle('inactive', !isActive);
          } catch (error) {
              console.error("í˜ì´ì§€ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
              alert("ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              event.target.checked = !isActive; // ì‹¤íŒ¨ ì‹œ ì›ìƒ ë³µêµ¬
          }
      }

      // --- ì •ë ¬ ê¸°ëŠ¥ (SortableJS) ---
      function initSortable() {
          new Sortable(pageListContainer, {
              handle: '.drag-handle', animation: 150,
              onEnd: async function (evt) {
                  // ë°°ì—´ ìˆœì„œ ë°˜ì˜
                  const movedItem = pageList.splice(evt.oldIndex, 1)[0];
                  pageList.splice(evt.newIndex, 0, movedItem);
                  
                  // Firestoreì— ìˆœì„œ ì—…ë°ì´íŠ¸ (Batch Write)
                  const batch = writeBatch(db);
                  pageList.forEach((page, index) => {
                      const docRef = doc(db, "pages", page.id);
                      batch.update(docRef, { order: index });
                  });
                  await batch.commit();
                  renderPageList(); // ìˆœì„œ ë³€ê²½ í›„ UI ì¦‰ì‹œ ë°˜ì˜ (ê¶Œì¥)
              },
          });
      }

      // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
      function showAuthMessage(message, isError) {
          authMessage.textContent = message;
          authMessage.className = `text-sm text-center mt-4 ${isError ? 'text-red-500' : 'text-slate-500'}`;
          authMessage.classList.remove('hidden');
      }

      function setButtonLoading(buttonElement, isLoading, loadingText) {
          buttonElement.disabled = isLoading;
          if (isLoading) {
              buttonElement.classList.add('button-disabled');
              buttonElement.innerHTML = `<span class="spinner inline-block mr-2"></span>${loadingText}`;
          } else {
              buttonElement.classList.remove('button-disabled');
              buttonElement.innerHTML = loadingText;
          }
      }

    </script>
</body>
</html>