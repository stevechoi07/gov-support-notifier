<!DOCTYPE html>
<html>
<head>
    <title>GD Shop - ìš°ë¦¬ ë™ë„¤ ì°©í•œê°€ê²©ì—…ì†Œ</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=bdae71c83941e7abbe59827c2625be7b"></script>
    <style>
        body { font-family: sans-serif; }
        #shop-list {
            margin-top: 20px; padding: 10px; border: 1px solid #ddd;
            border-radius: 5px; max-height: 200px; overflow-y: auto;
        }
        .shop-item {
            padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;
        }
        .shop-item:hover { background-color: #f9f9f9; }
        .shop-item:last-child { border-bottom: none; }
        .distance {
            font-weight: bold;
            color: #3498db;
        }
        #loader {
            display: none; margin-top: 20px; text-align: center;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>v1.8 GD Shop - ìš°ë¦¬ ë™ë„¤ ì°©í•œê°€ê²©ì—…ì†Œ ğŸ—ºï¸</h1>
    <p>ê°€ì¥ ê°€ê¹Œìš´ ì°©í•œ ê°€ê²Œë¥¼ ì°¾ì•„ë³´ì„¸ìš”!</p>
    <button id="find-btn">ë‚´ ìœ„ì¹˜ ì°¾ê¸°!</button>
    
    <div id="map" style="width:100%; height:500px; margin-top: 20px; border-radius: 5px;"></div>
    <div id="loader"><div class="spinner"></div><p>ê°€ê¹Œìš´ ê°€ê²Œë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</p></div>
    <div id="shop-list"></div>

    <script>
        const findBtn = document.getElementById('find-btn');
        const loader = document.getElementById('loader');
        const shopList = document.getElementById('shop-list');

        findBtn.addEventListener('click', findMyLocation);

        // V1.8 ì—…ë°ì´íŠ¸: ë‘ ì¢Œí‘œ ì‚¬ì´ì˜ ê±°ë¦¬ë¥¼ km ë‹¨ìœ„ë¡œ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
        function getDistance(lat1, lon1, lat2, lon2) {
            if ((lat1 == lat2) && (lon1 == lon2)) return 0;
            const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // ìµœì¢… ê±°ë¦¬ (km)
        }

        function findMyLocation() {
            document.getElementById('map').innerHTML = ""; 
            shopList.innerHTML = ''; 
            loader.style.display = 'block'; 
            navigator.geolocation.getCurrentPosition(success, error);
        }

        function success(position) {
            const myLat = position.coords.latitude;
            const myLng = position.coords.longitude;
            const mapContainer = document.getElementById('map'); 
            const map = new kakao.maps.Map(mapContainer, { 
                center: new kakao.maps.LatLng(myLat, myLng),
                level: 7
            }); 
            new kakao.maps.Marker({ position: new kakao.maps.LatLng(myLat, myLng) }).setMap(map);
            
            fetch('data.json')
                .then(response => response.json())
                .then(data => {
                    // --- ğŸ› ê°œë°œì ë””ë²„ê¹… íˆ´ ---
                    console.log('âœ… ì›ë³¸ ë°ì´í„°:', JSON.parse(JSON.stringify(data)));
                    // --------------------------

                    // V1.8 ì—…ë°ì´íŠ¸: ê° ê°€ê²Œê¹Œì§€ì˜ ê±°ë¦¬ë¥¼ ê³„ì‚°í•´ì„œ ë°ì´í„°ì— ì¶”ê°€
                    data.forEach(shop => {
                        shop.distance = getDistance(myLat, myLng, shop.lat, shop.lng);
                    });

                    // V1.8 ì—…ë°ì´íŠ¸: 'distance'ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
                    data.sort((a, b) => a.distance - b.distance);

                    // --- ğŸ› ê°œë°œì ë””ë²„ê¹… íˆ´ ---
                    console.log('âœ… ê±°ë¦¬ìˆœ ì •ë ¬ ì™„ë£Œ!', data);
                    // --------------------------

                    const infowindows = [];
                    data.forEach((shop) => {
                        const marker = new kakao.maps.Marker({
                             position: new kakao.maps.LatLng(shop.lat, shop.lng)
                        });
                        marker.setMap(map);

                        const infowindow = new kakao.maps.InfoWindow({
                            content : `<div style="padding:5px; font-size:14px; width:150px;">${shop.name}</div>`,
                            removable : true
                        });
                        infowindows.push(infowindow);

                        kakao.maps.event.addListener(marker, 'click', () => {
                            infowindows.forEach(iw => iw.close());
                            infowindow.open(map, marker);  
                        });

                        const listItem = document.createElement('div');
                        listItem.className = 'shop-item';
                        // V1.8 ì—…ë°ì´íŠ¸: ëª©ë¡ì— ê±°ë¦¬ í‘œì‹œ
                        listItem.innerHTML = `<b>${shop.name}</b> <span class="distance">(${shop.distance.toFixed(1)}km)</span><br><small>${shop.address}</small>`;
                        listItem.addEventListener('click', () => {
                            infowindows.forEach(iw => iw.close());
                            infowindow.open(map, marker);
                            map.panTo(marker.getPosition());
                        });
                        shopList.appendChild(listItem);
                    });
                    loader.style.display = 'none';
                })
                .catch(error => {
                    console.error('âŒ data.json íŒŒì¼ ë¡œë”© ì‹¤íŒ¨!', error)
                    loader.innerHTML = "ë°ì´í„° ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                });
        }

        function error() {
            document.getElementById('map').innerHTML = "ì£„ì†¡í•©ë‹ˆë‹¤. ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            loader.style.display = 'none';
        }
    </script>
</body>
</html>