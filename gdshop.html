<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>v7.0 GD Shop - 내 주변 착한가게 (The Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=bdae71c83941e7abbe59827c2625be7b"></script>
    <style>
        /* Custom styles for Grand Design */
        ::-webkit-scrollbar { display: none; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* Blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal Styles */
        #shop-modal { transition: opacity 0.3s ease-in-out; }
        #modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        #shop-modal.active { opacity: 1; pointer-events: auto; }
        #shop-modal.active #modal-content { transform: translateY(0); opacity: 1; }
        .filter-btn.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="bg-slate-50 font-sans">

    <div class="container mx-auto max-w-2xl p-4 md:p-6">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-slate-800 tracking-tight">v7.0 GD Shop 🏆</h1>
            <p class="text-slate-500 mt-1">내 주변 착한가게 (The Final)</p>
        </header>

        <main id="main-content" class="hidden">
            <!-- v7.0 업데이트: '치킨/분식' 버튼 추가 및 순서 조정 -->
            <div id="category-filters" class="flex flex-wrap justify-center gap-2 mb-6">
                <button data-category="전체" class="filter-btn active px-4 py-2 rounded-full text-sm font-semibold transition-all duration-200"># 전체보기</button>
                <button data-category="한식" class="filter-btn bg-white text-slate-700 px-4 py-2 rounded-full text-sm font-semibold shadow-sm hover:shadow-md transition-all duration-200"># 한식</button>
                <button data-category="치킨/분식" class="filter-btn bg-white text-slate-700 px-4 py-2 rounded-full text-sm font-semibold shadow-sm hover:shadow-md transition-all duration-200"># 치킨/분식</button>
                <button data-category="중식" class="filter-btn bg-white text-slate-700 px-4 py-2 rounded-full text-sm font-semibold shadow-sm hover:shadow-md transition-all duration-200"># 중식</button>
                <button data-category="일식" class="filter-btn bg-white text-slate-700 px-4 py-2 rounded-full text-sm font-semibold shadow-sm hover:shadow-md transition-all duration-200"># 일식</button>
                <button data-category="양식" class="filter-btn bg-white text-slate-700 px-4 py-2 rounded-full text-sm font-semibold shadow-sm hover:shadow-md transition-all duration-200"># 양식</button>
                <button data-category="서비스" class="filter-btn bg-white text-slate-700 px-4 py-2 rounded-full text-sm font-semibold shadow-sm hover:shadow-md transition-all duration-200"># 이미용/서비스</button>
            </div>

            <div id="map" class="w-full h-72 md:h-96 rounded-xl shadow-lg mb-6 ring-1 ring-black ring-opacity-5"></div>
            <div id="shop-list" class="space-y-3"></div>
            <div id="loader" class="flex justify-center items-center py-6 hidden"><div class="loader"></div></div>
        </main>
        
        <div id="initial-screen" class="text-center py-24">
            <button id="find-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                내 주변 착한가게 찾기
            </button>
            <p id="initial-message" class="text-slate-500 mt-4 h-5"></p>
        </div>
    </div>

    <div id="shop-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 opacity-0 pointer-events-none z-50">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-md transform translate-y-4 opacity-0 overflow-hidden">
            <div class="flex justify-between items-center p-5 border-b border-slate-200">
                <h2 id="modal-shop-name" class="text-lg font-bold text-slate-800"></h2>
                <button id="modal-close-btn" class="text-3xl text-slate-400 hover:text-slate-800 transition-colors">&times;</button>
            </div>
            <div id="modal-shop-details" class="p-6 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const findBtn = document.getElementById('find-btn');
        const initialScreen = document.getElementById('initial-screen');
        const mainContent = document.getElementById('main-content');
        const initialMessage = document.getElementById('initial-message');
        const shopList = document.getElementById('shop-list');
        const loader = document.getElementById('loader');
        const shopModal = document.getElementById('shop-modal');
        const modalContent = document.getElementById('modal-content');
        const modalShopName = document.getElementById('modal-shop-name');
        const modalShopDetails = document.getElementById('modal-shop-details');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        let map, userMarker, currentInfowindow;
        let markers = [];
        let userLocation = null;
        let currentPage = 1;
        let isLoading = false;
        let currentCategory = '전체';
        let noMoreData = false;

        findBtn.addEventListener('click', findMyLocation);
        modalCloseBtn.addEventListener('click', closeShopModal);
        shopModal.addEventListener('click', (e) => { if (e.target === shopModal) closeShopModal(); });

        function findMyLocation() {
            initialMessage.textContent = "위치 정보를 확인하는 중...";
            navigator.geolocation.getCurrentPosition(success, error);
        }

        function success(position) {
            userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
            initialScreen.classList.add('hidden');
            mainContent.classList.remove('hidden');
            initializeMap();
            setupFilterButtons();
            setupInfiniteScroll();
            fetchShops(true);
        }

        function error() {
            initialMessage.textContent = "위치 정보를 가져올 수 없습니다. 브라우저 설정을 확인해주세요.";
        }
        
        function initializeMap() {
            const mapContainer = document.getElementById('map');
            const mapOption = { center: new kakao.maps.LatLng(userLocation.lat, userLocation.lng), level: 5 };
            map = new kakao.maps.Map(mapContainer, mapOption);
            userMarker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(userLocation.lat, userLocation.lng),
                image: new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png', new kakao.maps.Size(64, 69), {offset: new kakao.maps.Point(27, 69)})
            });
            userMarker.setMap(map);
        }

        function setupFilterButtons() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentCategory = button.dataset.category;
                    fetchShops(true);
                });
            });
        }
        
        async function fetchShops(isNewSearch = false) {
            if (isLoading || (noMoreData && !isNewSearch)) return;
            isLoading = true;
            loader.classList.remove('hidden');

            if (isNewSearch) {
                currentPage = 1;
                noMoreData = false;
                shopList.innerHTML = '';
                markers.forEach(marker => marker.setMap(null));
                markers = [];
                if (currentInfowindow) currentInfowindow.close();
            }

            try {
                const response = await fetch(`/api/shops?lat=${userLocation.lat}&lng=${userLocation.lng}&category=${currentCategory}&page=${currentPage}`);
                if (!response.ok) throw new Error('주방(서버리스 함수)에서 응답이 없습니다!');
                const newShops = await response.json();
                
                if (newShops.length > 0) {
                    displayShops(newShops);
                    currentPage++;
                } else {
                    noMoreData = true;
                    if(isNewSearch) shopList.innerHTML = `<p class="text-center text-slate-500 py-8">이 카테고리에는 가게가 없네요!</p>`;
                }
            } catch (err) {
                console.error("❌ 홀에서 문제 발생!", err);
                shopList.innerHTML = `<p class="text-center text-red-500 py-8">이런! 가게 목록을 불러오는 데 실패했어요!</p>`;
            } finally {
                isLoading = false;
                loader.classList.add('hidden');
            }
        }

        function displayShops(shops) {
            shops.forEach(shop => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm hover:shadow-lg p-4 flex items-center gap-4 transition-all duration-300 transform hover:-translate-y-1 cursor-pointer';
                card.innerHTML = `
                    <div class="flex-shrink-0 w-12 h-12 bg-sky-100 text-sky-600 rounded-full flex items-center justify-center text-lg font-bold">${shop['업종'][0]}</div>
                    <div class="flex-grow min-w-0">
                        <h3 class="font-bold text-slate-800 truncate">${shop['업소명']}</h3>
                        <p class="text-sm text-slate-500 truncate">${shop['주소']}</p>
                    </div>
                    <div class="flex-shrink-0 text-right">
                        <p class="font-semibold text-blue-600">${shop.distance.toFixed(1)} km</p>
                    </div>
                `;
                shopList.appendChild(card);
                
                const markerPosition = new kakao.maps.LatLng(shop.lat, shop.lng);
                const marker = new kakao.maps.Marker({ position: markerPosition });
                marker.setMap(map);
                markers.push(marker);

                const infowindow = new kakao.maps.InfoWindow({ content: `<div style="padding:5px; font-size:13px; font-weight:bold;">${shop['업소명']}</div>`, removable: true });

                const openInfoWindow = () => {
                    if (currentInfowindow) currentInfowindow.close();
                    infowindow.open(map, marker);
                    currentInfowindow = infowindow;
                };

                kakao.maps.event.addListener(marker, 'click', openInfoWindow);
                card.addEventListener('click', () => {
                    map.panTo(markerPosition);
                    openInfoWindow();
                    showShopModal(shop);
                });
            });
        }
        
        function showShopModal(shop) {
            modalShopName.textContent = shop['업소명'];
            
            let detailsHtml = `<div class="space-y-4">
                <p class="text-sm text-slate-600 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg><span>${shop['연락처'] || '정보 없음'}</span></p>
                <div>
                    <h4 class="font-bold text-slate-700 mb-3">대표 메뉴</h4>
                    <ul class="space-y-2 text-sm divide-y divide-slate-100">`;

            let menuFound = false;
            for (let i = 1; i <= 4; i++) {
                const menu = shop[`메뉴${i}`];
                const price = shop[`가격${i}`];
                if (menu && price) {
                    menuFound = true;
                    detailsHtml += `
                        <li class="flex justify-between items-center pt-2">
                            <span class="text-slate-800">${menu}</span>
                            <span class="font-semibold text-blue-600">${Number(price).toLocaleString()}원</span>
                        </li>`;
                }
            }

            if (!menuFound) {
                detailsHtml += '<li class="text-slate-500 pt-2">대표 메뉴 정보가 없습니다.</li>';
            }

            detailsHtml += '</ul></div></div>';
            modalShopDetails.innerHTML = detailsHtml;

            shopModal.classList.add('active');
        }

        function closeShopModal() {
            shopModal.classList.remove('active');
        }

        function setupInfiniteScroll() {
            window.addEventListener('scroll', () => {
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 50 && !isLoading) {
                    fetchShops();
                }
            });
        }
    </script>
</body>
</html>