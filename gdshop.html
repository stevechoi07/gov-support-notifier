<!DOCTYPE html>
<html>
<head>
    <title>GD Shop - ìš°ë¦¬ ë™ë„¤ ì°©í•œê°€ê²©ì—…ì†Œ</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=bdae71c83941e7abbe59827c2625be7b&libraries=services"></script>
    <style>
        /* ìŠ¤íƒ€ì¼ì€ ì´ì „ ë²„ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤. */
        body { font-family: sans-serif; }
        #shop-list {
            margin-top: 20px; padding: 10px; border: 1px solid #ddd;
            border-radius: 5px; max-height: 250px; overflow-y: auto;
        }
        .shop-item {
            padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;
        }
        .shop-item:hover { background-color: #f9f9f9; }
        .shop-item:last-child { border-bottom: none; }
        .distance { font-weight: bold; color: #3498db; }
        #loader { display: none; margin-top: 20px; text-align: center; }
        #loader p { font-size: 14px; color: #555; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>v2.0 GD Shop - ìš°ë¦¬ ë™ë„¤ ì°©í•œê°€ê²©ì—…ì†Œ ğŸ—ºï¸</h1>
    <p>ì‹¤ì‹œê°„ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ì°©í•œ ê°€ê²Œë¥¼ ì°¾ì•„ë³´ì„¸ìš”!</p>
    <button id="find-btn">ë‚´ ìœ„ì¹˜ ì°¾ê¸°!</button>
    
    <div id="map" style="width:100%; height:500px; margin-top: 20px; border-radius: 5px;"></div>
    <div id="loader"><div class="spinner"></div><p id="loader-text">ê°€ê¹Œìš´ ê°€ê²Œë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</p></div>
    <div id="shop-list"></div>

    <script>
        const findBtn = document.getElementById('find-btn');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const shopList = document.getElementById('shop-list');

        findBtn.addEventListener('click', findMyLocation);
        
        function findMyLocation() {
            document.getElementById('map').innerHTML = ""; 
            shopList.innerHTML = ''; 
            loader.style.display = 'block'; 
            loaderText.innerText = 'ë‚´ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...';
            navigator.geolocation.getCurrentPosition(success, error);
        }

        async function success(position) {
            const myLat = position.coords.latitude;
            const myLng = position.coords.longitude;
            const mapContainer = document.getElementById('map'); 
            const map = new kakao.maps.Map(mapContainer, { 
                center: new kakao.maps.LatLng(myLat, myLng),
                level: 7
            }); 
            new kakao.maps.Marker({ position: new kakao.maps.LatLng(myLat, myLng) }).setMap(map);
            
            try {
                // ================================================================
                // V2.0 ì—…ë°ì´íŠ¸: ì£¼ë°©(ë°±ì—”ë“œ)ì— ìš”ë¦¬ë¥¼ ì£¼ë¬¸í•©ë‹ˆë‹¤!
                // ================================================================
                loaderText.innerText = 'ì£¼ë°©ì— ê°€ê¹Œìš´ ê°€ê²Œë¥¼ ì°¾ì•„ë‹¬ë¼ê³  ìš”ì²­í•˜ëŠ” ì¤‘...';
                
                // ìš°ë¦¬ ë°±ì—”ë“œ ì„œë²„ì— fetchë¡œ ê¹”ë”í•˜ê²Œ ìš”ì²­!
                const response = await fetch(`/api/shops?lat=${myLat}&lng=${myLng}`);
                const shops = await response.json();
                
                if (!response.ok) {
                    throw new Error(shops.message || "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
                
                console.log('âœ… ì£¼ë°©ì—ì„œ ìš”ë¦¬(ë°ì´í„°)ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤!', shops);

                const infowindows = [];
                shops.forEach((shop) => {
                    const marker = new kakao.maps.Marker({
                         position: new kakao.maps.LatLng(shop.lat, shop.lng)
                    });
                    marker.setMap(map);

                    const infowindow = new kakao.maps.InfoWindow({
                        content : `<div style="padding:5px; font-size:14px; width:150px;">${shop['ì—…ì†Œëª…']}</div>`,
                        removable : true
                    });
                    infowindows.push(infowindow);

                    kakao.maps.event.addListener(marker, 'click', () => {
                        infowindows.forEach(iw => iw.close());
                        infowindow.open(map, marker);  
                    });

                    const listItem = document.createElement('div');
                    listItem.className = 'shop-item';
                    listItem.innerHTML = `<b>${shop['ì—…ì†Œëª…']}</b> <span class="distance">(${shop.distance.toFixed(1)}km)</span><br><small>${shop['ì£¼ì†Œ']}</small>`;
                    listItem.addEventListener('click', () => {
                        infowindows.forEach(iw => iw.close());
                        infowindow.open(map, marker);
                        map.panTo(marker.getPosition());
                    });
                    shopList.appendChild(listItem);
                });

                loader.style.display = 'none';

            } catch (err) {
                console.error('âŒ í™€ì—ì„œ ë¬¸ì œ ë°œìƒ!', err);
                loaderText.innerText = `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}`;
            }
        }

        function error() {
            document.getElementById('map').innerHTML = "ì£„ì†¡í•©ë‹ˆë‹¤. ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            loader.style.display = 'none';
        }
    </script>
</body>
</html>