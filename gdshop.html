<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>v4.0 GD Shop - 내 주변 착한가게 (Serverless)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=bdae71c83941e7abbe59827c2625be7b"></script>
    <style>
        /* Custom styles for a better look and feel */
        ::-webkit-scrollbar { display: none; } /* Hide scrollbar for a cleaner look */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto max-w-4xl p-4">
        <header class="text-center mb-4">
            <h1 class="text-3xl font-bold text-gray-800">v4.0 GD Shop 🚀</h1>
            <p class="text-gray-600">내 주변 착한가게 (Serverless Edition)</p>
        </header>

        <main id="main-content" class="hidden">
            <!-- Category filter buttons -->
            <div id="category-filters" class="flex flex-wrap justify-center gap-2 mb-4">
                <button data-category="전체" class="filter-btn bg-blue-500 text-white px-4 py-2 rounded-full text-sm font-semibold shadow-md"># 전체보기</button>
                <button data-category="한식" class="filter-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold shadow-md"># 한식</button>
                <button data-category="중식" class="filter-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold shadow-md"># 중식</button>
                <button data-category="일식" class="filter-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold shadow-md"># 일식</button>
                <button data-category="서비스" class="filter-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold shadow-md"># 이미용/서비스</button>
            </div>

            <!-- Map container -->
            <div id="map" class="w-full h-64 md:h-80 rounded-lg shadow-lg mb-4"></div>

            <!-- Shop list container -->
            <div id="shop-list" class="space-y-3"></div>
            
            <!-- Loader for infinite scroll -->
            <div id="loader" class="flex justify-center items-center py-4 hidden">
                <div class="loader"></div>
            </div>
        </main>
        
        <!-- Initial screen -->
        <div id="initial-screen" class="text-center py-20">
            <button id="find-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                내 주변 착한가게 찾기!
            </button>
            <p id="initial-message" class="text-gray-500 mt-4"></p>
        </div>
    </div>

    <script>
        const findBtn = document.getElementById('find-btn');
        const initialScreen = document.getElementById('initial-screen');
        const mainContent = document.getElementById('main-content');
        const initialMessage = document.getElementById('initial-message');
        const shopList = document.getElementById('shop-list');
        const loader = document.getElementById('loader');

        let map, userMarker;
        let markers = [];
        let userLocation = null;
        let currentPage = 1;
        let isLoading = false;
        let currentCategory = '전체';
        let noMoreData = false;

        findBtn.addEventListener('click', findMyLocation);

        function findMyLocation() {
            initialMessage.textContent = "위치 정보를 확인하는 중...";
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(success, error);
            } else {
                error();
            }
        }

        function success(position) {
            userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            initialScreen.classList.add('hidden');
            mainContent.classList.remove('hidden');
            initializeMap();
            setupFilterButtons();
            setupInfiniteScroll();
            fetchShops(true);
        }

        function initializeMap() {
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(userLocation.lat, userLocation.lng),
                level: 5
            };
            map = new kakao.maps.Map(mapContainer, mapOption);
            userMarker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(userLocation.lat, userLocation.lng),
                image: new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png', new kakao.maps.Size(64, 69), {offset: new kakao.maps.Point(27, 69)})
            });
            userMarker.setMap(map);
        }

        function error() {
            initialMessage.textContent = "위치 정보를 가져올 수 없습니다. 브라우저 설정을 확인해주세요.";
        }

        function setupFilterButtons() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => {
                        btn.classList.remove('bg-blue-500', 'text-white');
                        btn.classList.add('bg-white', 'text-gray-700');
                    });
                    button.classList.add('bg-blue-500', 'text-white');
                    button.classList.remove('bg-white', 'text-gray-700');
                    
                    currentCategory = button.dataset.category;
                    fetchShops(true);
                });
            });
        }
        
        async function fetchShops(isNewSearch = false) {
            if (isLoading || (noMoreData && !isNewSearch)) return;
            isLoading = true;
            loader.classList.remove('hidden');

            if (isNewSearch) {
                currentPage = 1;
                noMoreData = false;
                shopList.innerHTML = '';
                markers.forEach(marker => marker.setMap(null));
                markers = [];
            }

            try {
                // Netlify's redirect rule automatically proxies this to our serverless function.
                const response = await fetch(`/api/shops?lat=${userLocation.lat}&lng=${userLocation.lng}&category=${currentCategory}&page=${currentPage}`);
                
                if (!response.ok) throw new Error('주방(서버리스 함수)에서 응답이 없습니다!');
                const newShops = await response.json();
                
                if (newShops.length > 0) {
                    displayShops(newShops);
                    currentPage++;
                } else {
                    noMoreData = true;
                    if(isNewSearch) shopList.innerHTML = `<p class="text-center text-gray-500">이 카테고리에는 가게가 없네요!</p>`;
                }

            } catch (err) {
                console.error("❌ 홀에서 문제 발생!", err);
                shopList.innerHTML = `<p class="text-center text-red-500">이런! 가게 목록을 불러오는 데 실패했어요!</p>`;
            } finally {
                isLoading = false;
                loader.classList.add('hidden');
            }
        }

        function displayShops(shops) {
            shops.forEach(shop => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-4 flex items-center gap-4 transition-transform transform hover:scale-102 cursor-pointer';
                card.innerHTML = `
                    <div class="flex-shrink-0 w-12 h-12 bg-blue-100 text-blue-500 rounded-full flex items-center justify-center text-xl font-bold">${shop['업종'][0]}</div>
                    <div class="flex-grow">
                        <h3 class="font-bold text-gray-800">${shop['업소명']}</h3>
                        <p class="text-sm text-gray-500">${shop['주소']}</p>
                    </div>
                    <div class="flex-shrink-0 text-right">
                        <p class="font-semibold text-blue-500">${shop.distance.toFixed(1)} km</p>
                    </div>
                `;
                shopList.appendChild(card);
                const marker = new kakao.maps.Marker({ position: new kakao.maps.LatLng(shop.lat, shop.lng) });
                marker.setMap(map);
                markers.push(marker);

                const infowindow = new kakao.maps.InfoWindow({ content: `<div style="padding:5px;">${shop['업소명']}</div>`, removable: true });

                kakao.maps.event.addListener(marker, 'click', function() {
                    infowindow.open(map, marker);
                });

                card.addEventListener('click', () => {
                    map.panTo(marker.getPosition());
                    infowindow.open(map, marker);
                });
            });
        }

        function setupInfiniteScroll() {
            window.addEventListener('scroll', () => {
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100 && !isLoading) {
                    fetchShops();
                }
            });
        }
    </script>
</body>
</html>