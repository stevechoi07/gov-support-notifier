<!DOCTYPE html>
<html>
<head>
    <title>GD Shop - 우리 동네 착한가격업소</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=bdae71c83941e7abbe59827c2625be7b&libraries=services"></script>
    <style>
        /* 스타일은 이전 버전과 동일합니다. */
        body { font-family: sans-serif; }
        #shop-list {
            margin-top: 20px; padding: 10px; border: 1px solid #ddd;
            border-radius: 5px; max-height: 250px; overflow-y: auto;
        }
        .shop-item {
            padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;
        }
        .shop-item:hover { background-color: #f9f9f9; }
        .shop-item:last-child { border-bottom: none; }
        .distance { font-weight: bold; color: #3498db; }
        #loader { display: none; margin-top: 20px; text-align: center; }
        #loader p { font-size: 14px; color: #555; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>v2.0 GD Shop - 우리 동네 착한가격업소 🗺️</h1>
    <p>실시간으로 가장 가까운 착한 가게를 찾아보세요!</p>
    <button id="find-btn">내 위치 찾기!</button>
    
    <div id="map" style="width:100%; height:500px; margin-top: 20px; border-radius: 5px;"></div>
    <div id="loader"><div class="spinner"></div><p id="loader-text">가까운 가게를 찾고 있습니다...</p></div>
    <div id="shop-list"></div>

    <script>
        const findBtn = document.getElementById('find-btn');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const shopList = document.getElementById('shop-list');

        findBtn.addEventListener('click', findMyLocation);
        
        function findMyLocation() {
            document.getElementById('map').innerHTML = ""; 
            shopList.innerHTML = ''; 
            loader.style.display = 'block'; 
            loaderText.innerText = '내 위치를 확인하는 중...';
            navigator.geolocation.getCurrentPosition(success, error);
        }

        async function success(position) {
            const myLat = position.coords.latitude;
            const myLng = position.coords.longitude;
            const mapContainer = document.getElementById('map'); 
            const map = new kakao.maps.Map(mapContainer, { 
                center: new kakao.maps.LatLng(myLat, myLng),
                level: 7
            }); 
            new kakao.maps.Marker({ position: new kakao.maps.LatLng(myLat, myLng) }).setMap(map);
            
            try {
                // ================================================================
                // V2.0 업데이트: 주방(백엔드)에 요리를 주문합니다!
                // ================================================================
                loaderText.innerText = '주방에 가까운 가게를 찾아달라고 요청하는 중...';
                
                // 우리 백엔드 서버에 fetch로 깔끔하게 요청!
                const response = await fetch(`/api/shops?lat=${myLat}&lng=${myLng}`);
                const shops = await response.json();
                
                if (!response.ok) {
                    throw new Error(shops.message || "데이터를 불러오는 데 실패했습니다.");
                }
                
                console.log('✅ 주방에서 요리(데이터)가 도착했습니다!', shops);

                const infowindows = [];
                shops.forEach((shop) => {
                    const marker = new kakao.maps.Marker({
                         position: new kakao.maps.LatLng(shop.lat, shop.lng)
                    });
                    marker.setMap(map);

                    const infowindow = new kakao.maps.InfoWindow({
                        content : `<div style="padding:5px; font-size:14px; width:150px;">${shop['업소명']}</div>`,
                        removable : true
                    });
                    infowindows.push(infowindow);

                    kakao.maps.event.addListener(marker, 'click', () => {
                        infowindows.forEach(iw => iw.close());
                        infowindow.open(map, marker);  
                    });

                    const listItem = document.createElement('div');
                    listItem.className = 'shop-item';
                    listItem.innerHTML = `<b>${shop['업소명']}</b> <span class="distance">(${shop.distance.toFixed(1)}km)</span><br><small>${shop['주소']}</small>`;
                    listItem.addEventListener('click', () => {
                        infowindows.forEach(iw => iw.close());
                        infowindow.open(map, marker);
                        map.panTo(marker.getPosition());
                    });
                    shopList.appendChild(listItem);
                });

                loader.style.display = 'none';

            } catch (err) {
                console.error('❌ 홀에서 문제 발생!', err);
                loaderText.innerText = `오류가 발생했습니다: ${err.message}`;
            }
        }

        function error() {
            document.getElementById('map').innerHTML = "죄송합니다. 위치 정보를 가져올 수 없습니다.";
            loader.style.display = 'none';
        }
    </script>
</body>
</html>